<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics Dashboard</title>
  <style>
    :root{color-scheme:dark}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0b0b;color:#e6e6e6}
    header{padding:16px 20px;border-bottom:1px solid #222;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:16px}
    .card{grid-column:span 12;background:#161616;border:1px solid #222;border-radius:14px;padding:16px}
    @media(min-width:900px){
      .span-4{grid-column:span 4}
      .span-8{grid-column:span 8}
    }
    .muted{opacity:.8;font-size:12px}
    canvas{width:100%;height:220px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #222;text-align:left}
  </style>

  <!-- Matomo init (auto-injected) -->
  <script>
    window.MATOMO_BASE_URL = window.MATOMO_BASE_URL || "{{MATOMO_URL}}/";
    window.MATOMO_SITE_ID = window.MATOMO_SITE_ID || "{{MATOMO_SITE_ID}}";
  </script>
  <script src="src/analytics/init-matomo.js"></script>
</head>
<body>
<header>
  <div><strong>Analytics Dashboard</strong></div>
  <div class="muted" id="updated">—</div>
</header>
<main class="grid">
  <section class="card span-8">
    <h3>Funnel (Goals)</h3>
    <div id="funnel">Loading…</div>
  </section>
  <section class="card span-4">
    <h3>Channels (Last 24h)</h3>
    <table id="channels"><thead><tr><th>Channel</th><th>Visits</th></tr></thead><tbody></tbody></table>
  </section>
  <section class="card span-12">
    <h3>Live</h3>
    <iframe src="/widget" style="width:100%;height:320px;border:0;border-radius:12px;background:#0b0b0b"></iframe>
  </section>
</main>
<script type="module">
  async function api(method, params={}){
    const usp = new URLSearchParams({
      module: "API",
      method,
      format: "JSON",
      ...params
    });
    const res = await fetch(`/live?${usp.toString()}`);
    return res.json();
  }
  async function load(){
    document.getElementById('updated').textContent = new Date().toLocaleString();
    // Very light inference: pull last visits and compute pseudo-funnel based on actionDetails
    const visits = await api("Live.getLastVisitsDetails", { period: "day", date: "today", countVisitorsToFetch: 200 });
    const steps = [
      { key: "landing", label: "Landing" },
      { key: "cta", label: "CTA Click" },
      { key: "form", label: "Form Submit" },
      { key: "thankyou", label: "Thank You" },
    ];
    const agg = { landing:0, cta:0, form:0, thankyou:0 };
    for (const v of visits){
      agg.landing += 1;
      for (const a of v.actionDetails || []){
        const url = (a.url||"");
        const et = a.eventCategory ? (a.eventCategory+":"+a.eventAction+":"+ (a.eventName||"")) : "";
        if (et.startsWith("cta:click")) agg.cta += 1;
        if (et.startsWith("form:submit")) agg.form += 1;
        if (url.includes("/thank-you")) agg.thankyou += 1;
      }
    }
    const f = document.getElementById('funnel'); f.innerHTML = '';
    const total = agg.landing || 1;
    for (const s of steps){
      const v = agg[s.key];
      const pct = Math.round((v/total)*100);
      const bar = document.createElement('div');
      bar.style.margin = "8px 0"; bar.style.background = "#0b0b0b"; bar.style.border="1px solid #222"; bar.style.borderRadius="10px"; bar.style.overflow="hidden";
      const inner = document.createElement('div');
      inner.style.width = pct+"%"; inner.style.height="24px"; inner.style.background="#2f81f7";
      bar.appendChild(inner);
      const label = document.createElement('div'); label.className="muted"; label.textContent = `${s.label}: ${v} (${pct}%)`;
      f.appendChild(bar); f.appendChild(label);
    }
    // Channels (basic tally from visits)
    const ch = {};
    for (const v of visits){
      const ref = v.referrerTypeName || "Direct";
      ch[ref] = (ch[ref]||0)+1;
    }
    const tbody = document.querySelector('#channels tbody'); tbody.innerHTML='';
    for (const [k,val] of Object.entries(ch).sort((a,b)=>b[1]-a[1])){
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${k}</td><td>${val}</td>`; tbody.appendChild(tr);
    }
  }
  load(); setInterval(load, 15000);
</script>
</body>
</html>